var myData;
var notLoaded = true;
var backupMyData = '[{"id":"me","title":[{"type":"text","value":"The EU and Me"}],"intro":[{"type":"text","value":"EU citizens can ğŸ  *live and *ğŸ¢* work*Â in any other EU country, and are affected by the EUâ€™s rules on the ğŸ’° *price and *ğŸ”§* quality*Â of things like travel, healthcare, energy and phone tariffs."},{"type":"sources","value":[]}],"in":[{"bullet":"âœˆ â™» **Free movement:**Â Around *1.2 million Brits *ğŸŒ´* live abroad*Â in the EU, and having membership *makes travel easier*.","sources":[]},{"bullet":"ğŸ’· â¬†**Prices would rise:** *Flights, healthcare, energy and *ğŸ“±* phone tariffs*Â are all likely (though not guaranteed) to go up in price if we leave the EU.","sources":[]},{"bullet":"ğŸ’ª ğŸ‘¥ **Deal-making power:**Â The EU negotiates ğŸ’¡ energy deals as a large, supposedly *stronger, bloc*.","sources":[]}],"out":[{"bullet":"ğŸ™Š ğŸ’¬ **Limited power:**Â The UK Government is limited in its *ability to *ğŸš·* reduce immigration*Â due to the rules of being in the EU.","sources":[]},{"bullet":"ğŸŒ ğŸ”€ **Slow to change:**Â The UK is *unable to change legislation like the *ğŸšº* â€˜tampon taxâ€™*Â without it going through the EU, which often takes more time.","sources":[]},{"bullet":"ğŸ’¡ ğŸ‘Œ **Energy independent:**Â Most of the UK\'s ğŸ’¨ *gas imports come from Norway*Â â€“ Britain is not dependent on Russia","sources":[]}],"subsections":[{"id":"prices","title":[{"type":"text","value":"Prices"}],"comingsoon":"true","intro":[{"type":"text","value":"The EUâ€™s single market regulates various aspects of trade such as price, quality and competition, and there is debate over whether this makes households better or worse off."},{"type":"sources","value":[]}],"in":[{"bullet":"The EU has recently put a cap on ğŸ“± mobile roaming charges and will extend this to a complete ban on additional roaming fees in April 2017","sources":[]},{"bullet":"","sources":[]},{"bullet":"","sources":[]}],"out":[{"bullet":"â€¦.First prices out bulletâ€¦.","sources":[]},{"bullet":"","sources":[]},{"bullet":"","sources":[]}]},{"id":"travel","title":[{"type":"text","value":"Travel"}],"comingsoon":"true","intro":[{"type":"text","value":"Some travel intro here!"},{"type":"sources","value":[]}],"in":[{"bullet":"The first bullet for the Travel subsection,....","sources":[]},{"bullet":"","sources":[]},{"bullet":"","sources":[]}],"out":[{"bullet":"â€¦.First travel out bulletâ€¦.","sources":[]},{"bullet":"","sources":[]},{"bullet":"","sources":[]}]},{"id":"travel","title":[{"type":"text","value":"Workersâ€™ rights"}],"comingsoon":"true","intro":[{"type":"text","value":"Some travel intro here!"},{"type":"sources","value":[]}],"in":[{"bullet":"The first bullet for the Travel subsection,....","sources":[],"Bbullet":"*27 million UK citizens* Â have a European Health Insurance Card. Â This entitles them to healthcare equivalent to that of the NHS Â  ğŸ¥ Â whilst travelling within the European Union."},{"bullet":"","sources":[]}],"out":[{"bullet":"â€¦.First travel out bulletâ€¦.","sources":[]},{"bullet":"","sources":[]},{"bullet":"","sources":[]}]}]},{"id":"money","title":[{"type":"text","value":"The EU and Money"}],"intro":[{"type":"text","value":"The UK contributes around *Â£8.5bn in fees* to the EU each year (or Â£161m a week), once you discount the money we get straight back."},{"type":"sources","value":[]}],"in":[{"bullet":"ğŸ’° ğŸ **Buying & Selling:**Â Over *40% of British exports* go to the EU and *53% of our products* come from the EU.","sources":[]},{"bullet":"ğŸ“¦ ğŸ“œ **Trading rules:**Â Even after Brexit, Britain would *still have to comply with EU rules*Â to trade with EU countries.","sources":[]},{"bullet":"ğŸ“‰ ğŸš§ **Slower growth:**Â If we left the EU an estimated *Â£36bn would be lost*Â due to slower growth reducing the total tax paid to the Treasury.","sources":[]}],"out":[{"bullet":"ğŸ ğŸ’¸ Â **Charity fund:**Â Some of the *Â£161m* that we spend every week contributes to *bailing out nations like Greece*, instead of being spent on the UK.","sources":[]},{"bullet":"ğŸš¯ ğŸ’³ **Pocket money T&Cs:**Â Even the money we get straight back from things like rebates comes with *rules about what we can spend it on*.","sources":[]},{"bullet":"ğŸ¾ ğŸš¸ **Trodden path:**Â Britain could *emulate countries like Norway or Switzerland*, both prosperous and with a high standard-of-living, and *re-establish trade links* with EU states.","sources":[]}],"subsections":[{"id":"fees","title":[{"type":"text","value":"Membership Fees"}],"comingsoon":"true","intro":[{"type":"text","value":"â€¦.Fees introâ€¦.."},{"type":"sources","value":[]}],"in":[{"bullet":"...first fees In bulletâ€¦.","sources":[]},{"bullet":"","sources":[]},{"bullet":"","sources":[]}],"out":[{"bullet":"â€¦.First fees out bulletâ€¦.","sources":[]},{"bullet":"","sources":[]},{"bullet":"","sources":[]}]}]},{"id":"power","title":[{"type":"text","value":"The EU and Power"}],"intro":[{"type":"text","value":"We join other European countries in *signing up to the rules* of being in the EU, affecting things like fishing waters, renewable energy policies, limits on workersâ€™ hours per week."},{"type":"sources","value":[]}],"in":[{"bullet":"ğŸ’ª ğŸ‘¥ **Stronger in:**Â In a competitive, ğŸŒ *globalised world* Â the UK needs to stay in the EU to *help shape laws*Â which affect the UK from the inside.","sources":[]},{"bullet":"âœŒ ğŸ‘Š **Double hit:**Â The government doesnâ€™t just influence through voting but also in *negotiating over the actual text*Â of laws.","sources":[]},{"bullet":"ğŸ’ ğŸ‘ **Helpful laws:**Â Many EU laws benefit the UK, for instance the new EU CAP will invest Â£22 billion over the next 7 years","sources":[]}],"out":[{"bullet":"ğŸ’ª ğŸ’¬ **Big influence:**Â Between *15% and 55%*Â of UK laws and regulations stem from the EU.","sources":[{"type":"https","value":"//fullfact.org/news/what-proportion-uk-law-comes-brussels/"}]},{"bullet":"ğŸ™‹ ğŸš¶ **Voted out:**Â In recent years the UK has been *on the losing side*Â of fighting EU laws, and now *loses a higher proportion of votes*Â than any other member.","sources":[]},{"bullet":"â›” ğŸš· **Held back:**Â Open Europe estimates that the 100 most expensive EU regulations set back the UK economy by Â£27.4 billion a year.","sources":[]}],"subsections":[]},{"id":"borders","title":[{"type":"text","value":"The EU and Borders"}],"intro":[{"type":"text","value":"Total net migration to the UK is over *300,000 a year*, half of which is from the EU, while the governmentâ€™s target is under 100,000. EU citizens have the *right to live and work*Â in any member state."},{"type":"sources","value":[]}],"in":[{"bullet":"âœˆ âœ… **Migrants benefit us:**Â EU citizens living in Britain *pay more in taxes than they receive in benefits*Â and the Remain side say theyâ€™re good for the economy.","sources":[]},{"bullet":"ğŸ”§ ğŸ”© **Tightening rules:**Â Benefits for new EU migrant workers will soon be *limited for the first four years*.","sources":[]}],"out":[{"bullet":"ğŸ”“ âš  **Lacking control:**Â Immigration can *only be controlled so much*Â when youâ€™re an EU member","sources":[]},{"bullet":"ğŸš· ğŸšª **Security risks:**Â The Schengen Area means someone crossing the channel could have entered Europe *from almost any bordering country*.","sources":[]}],"subsections":[]}]';

$.doctop({
  url: 'https://docs.google.com/document/d/15oMHuBNX4CTMvaAm7piTaWVwpc8kaO0bDLg190p5Qdc/pub',
  archieml: true,
  cache: false,
  callback: function(d){
      notLoaded = false;
      console.dir(d);
      myData = d.copy.archie.sections;
      console.log(myData);
      getAllPanelsHTML(myData);
  }
});

var getAllPanelsHTML = function(data) {
  // $('.tab-content').html('');
  $.each(data, function(i, e) {
    var panelHTML = getPanelHTML(i, e);
    // $('.tab-content').append(panelHTML);
  });
};

var getPanelHTML = function(i, data) {
  var intro = boldify(data.intro[0].value);
  var inOut = getInOutHTML(data);
  var subsectionsHTML = '';
  var subsectionsHTML1 = '';
  $.each(data.subsections, function(i, e) {
    subsectionsHTML += getSubsectionHTML(e, '');
    subsectionsHTML1 += getSubsectionHTML(e, '1');
  });
  subsectionsHTML = '<div class="panel-group" id="accordion" role="tablist" aria-multiselectable="true">' + subsectionsHTML + '</div>';
  subsectionsHTML1 = '<div class="panel-group" id="accordion" role="tablist" aria-multiselectable="true">' + subsectionsHTML1 + '</div>';
  // var firstBit = i==0 ? ' in active' : '';
  // var panelHTML = '<div role="tabpanel" class="tab-pane fade' + firstBit + '" id="' + data.id + '1"><p>' + intro + inOut + '</p></div>';
  var panelHTML = '<p>' + intro + '</p>' + inOut + subsectionsHTML;
  var panelHTML1 = '<p>' + intro + '</p>' + inOut + subsectionsHTML1;
  $('#' + data.id + '1').html(panelHTML1);
  $('#' + data.id).html(panelHTML);
  // $('.panel-title a').click(function() {
    // console.log(this.getAttribute('href'));
    // $(this.getAttribute('href')).
  // })
  return panelHTML;
};

var getInOutHTML = function(data) {
  var allInOutHTML = '';
  var inHTML = '';
  var outHTML = '';
  $.each(data.in, function(i, e) {
    inHTML += '<li>' + boldify(e.bullet) + '</li>';
  });
  $.each(data.out, function(i, e) {
    outHTML += '<li>' + boldify(e.bullet) + '</li>';
  });
  inHTML = '<div class="in"><h3>In</h3><ul>' + inHTML + '</ul></div>';
  outHTML = '<div class="out"><h3>Out</h3><ul>' + outHTML + '</ul></div>';
  inOutHTML = '<div class="in-out">' + inHTML + outHTML + '</div>';
  return inOutHTML;
};

var getSubsectionHTML = function(data, desktop) {
  console.log(desktop);
  var intro = boldify(data.intro[0].value);
  var inOut = getSubsectionInOutHTML(data, desktop);
  var comingsoon = '<div class="coming-soon"><h3>âŒ› This section is coming&nbsp;soon..! âŒ›</h3><h4>ğŸ™ˆ ğŸ™‰ ğŸ™Š Don\'t miss out on getting involved - <b>help us ğŸ“ write this section</b>! ğŸ“¨ Email <a href="mailto:FOMO@referendum.wtf">FOMO@referendum.wtf</a></h4></div>'
  var content = data.comingsoon ? comingsoon : intro + inOut;
  // var firstBit = i==0 ? ' in active' : '';
  var panelHTML = '<div class="panel panel-default"><div class="panel-heading" role="tab" id="heading' + data.id + desktop + '"><h4 class="panel-title"><a role="button" data-toggle="collapse" data-parent="#accordion" href="#collapse' + data.id + desktop + '"prices" aria-expanded="false" aria-controls="collapse' + data.id + desktop + '" class="collapsed">' + data.title[0].value + '</a></h4></div> <div id="collapse' + data.id + desktop + '" class="panel-collapse collapse" role="tabpanel" aria-labelledby="heading' + data.id + desktop + '"><div class="panel-body">' + content + '</div></div></div>';
  // var panelHTML = '<p>' + intro + inOut + '</p>';
  // $('#subsection-' + data.id + '1').html(panelHTML);
  // $('#subsection-' + data.id).html(panelHTML);
  return panelHTML;
}

var getSubsectionInOutHTML = function(data) {
  var allInOutHTML = '';
  var inHTML = '';
  var outHTML = '';
  $.each(data.in, function(i, e) {
    inHTML += '<li>' + boldify(e.bullet) + '</li>';
  });
  $.each(data.out, function(i, e) {
    outHTML += '<li>' + boldify(e.bullet) + '</li>';
  });
  inHTML = '<div class="in"><h3>In</h3><ul>' + inHTML + '</ul></div>';
  outHTML = '<div class="out"><h3>Out</h3><ul>' + outHTML + '</ul></div>';
  inOutHTML = '<div class="in-out">' + inHTML + outHTML + '</div>';
  return inOutHTML;
};

var boldify = function(text) {
  // bolded=text.replace(/\*.+\*/gi, function myFunction(x){return '<b>' + x + '</b>';});
  // bolded = bolded.replace(/\*/gi, "");
  var bolded = !text ? text : text.replace(/\*\*([^*]+?)\*\*/g, '<div class="bullet-heading">$1<\/div>')
                                  .replace(/\*([^*]+?)\*/g, '<b>$1<\/b>');
  return bolded;
}


setTimeout(function() {
  // if (notLoaded) {
    myData = $.parseJSON(backupMyData);
    getAllPanelsHTML(myData);
    // var whoops = '<div class="coming-soon"><h3>ğŸ˜³ Well, this is awkward..! ğŸ˜³</h3><h4>ğŸ™ˆ ğŸ™‰ ğŸ™Š We seem to have failed to load much here - <b>please help us figure out why</b>! ğŸ“¨ Email <a href="mailto:whoops@referendum.wtf">whoops@referendum.wtf</a></h4></div>'
    // $('.tab-pane').html(whoops);
    // $('.tab-content').html(whoops);
  // }
}, 1000)
