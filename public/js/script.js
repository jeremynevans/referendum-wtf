var myData;
var notLoaded = true;
var backupMyData = '[{"id":"me","title":[{"type":"text","value":"The EU and Me"}],"intro":[{"type":"text","value":"EU citizens can 🏠 *live and *🏢* work* in any other EU country, and are affected by the EU’s rules on the 💰 *price and *🔧* quality* of things like travel, healthcare, energy and phone tariffs."},{"type":"sources","value":[]}],"in":[{"bullet":"✈ ♻ **Free movement:** Around *1.2 million Brits *🌴* live abroad* in the EU, and having membership *makes travel easier*.","sources":[]},{"bullet":"💷 ⬆**Prices would rise:** *Flights, healthcare, energy and *📱* phone tariffs* are all likely (though not guaranteed) to go up in price if we leave the EU.","sources":[]},{"bullet":"💪 👥 **Deal-making power:** The EU negotiates 💡 energy deals as a large, supposedly *stronger, bloc*.","sources":[]}],"out":[{"bullet":"🙊 💬 **Limited power:** The UK Government is limited in its *ability to *🚷* reduce immigration* due to the rules of being in the EU.","sources":[]},{"bullet":"🐌 🔀 **Slow to change:** The UK is *unable to change legislation like the *🚺* ‘tampon tax’* without it going through the EU, which often takes more time.","sources":[]},{"bullet":"💡 👌 **Energy independent:** Most of the UK\'s 💨 *gas imports come from Norway* – Britain is not dependent on Russia","sources":[]}],"subsections":[{"id":"prices","title":[{"type":"text","value":"Prices"}],"comingsoon":"true","intro":[{"type":"text","value":"The EU’s single market regulates various aspects of trade such as price, quality and competition, and there is debate over whether this makes households better or worse off."},{"type":"sources","value":[]}],"in":[{"bullet":"The EU has recently put a cap on 📱 mobile roaming charges and will extend this to a complete ban on additional roaming fees in April 2017","sources":[]},{"bullet":"","sources":[]},{"bullet":"","sources":[]}],"out":[{"bullet":"….First prices out bullet….","sources":[]},{"bullet":"","sources":[]},{"bullet":"","sources":[]}]},{"id":"travel","title":[{"type":"text","value":"Travel"}],"comingsoon":"true","intro":[{"type":"text","value":"Some travel intro here!"},{"type":"sources","value":[]}],"in":[{"bullet":"The first bullet for the Travel subsection,....","sources":[]},{"bullet":"","sources":[]},{"bullet":"","sources":[]}],"out":[{"bullet":"….First travel out bullet….","sources":[]},{"bullet":"","sources":[]},{"bullet":"","sources":[]}]},{"id":"travel","title":[{"type":"text","value":"Workers’ rights"}],"comingsoon":"true","intro":[{"type":"text","value":"Some travel intro here!"},{"type":"sources","value":[]}],"in":[{"bullet":"The first bullet for the Travel subsection,....","sources":[],"Bbullet":"*27 million UK citizens*  have a European Health Insurance Card.  This entitles them to healthcare equivalent to that of the NHS   🏥  whilst travelling within the European Union."},{"bullet":"","sources":[]}],"out":[{"bullet":"….First travel out bullet….","sources":[]},{"bullet":"","sources":[]},{"bullet":"","sources":[]}]}]},{"id":"money","title":[{"type":"text","value":"The EU and Money"}],"intro":[{"type":"text","value":"The UK contributes around *£8.5bn in fees* to the EU each year (or £161m a week), once you discount the money we get straight back."},{"type":"sources","value":[]}],"in":[{"bullet":"💰 🎁 **Buying & Selling:** Over *40% of British exports* go to the EU and *53% of our products* come from the EU.","sources":[]},{"bullet":"📦 📜 **Trading rules:** Even after Brexit, Britain would *still have to comply with EU rules* to trade with EU countries.","sources":[]},{"bullet":"📉 🚧 **Slower growth:** If we left the EU an estimated *£36bn would be lost* due to slower growth reducing the total tax paid to the Treasury.","sources":[]}],"out":[{"bullet":"🎁 💸  **Charity fund:** Some of the *£161m* that we spend every week contributes to *bailing out nations like Greece*, instead of being spent on the UK.","sources":[]},{"bullet":"🚯 💳 **Pocket money T&Cs:** Even the money we get straight back from things like rebates comes with *rules about what we can spend it on*.","sources":[]},{"bullet":"🐾 🚸 **Trodden path:** Britain could *emulate countries like Norway or Switzerland*, both prosperous and with a high standard-of-living, and *re-establish trade links* with EU states.","sources":[]}],"subsections":[{"id":"fees","title":[{"type":"text","value":"Membership Fees"}],"comingsoon":"true","intro":[{"type":"text","value":"….Fees intro….."},{"type":"sources","value":[]}],"in":[{"bullet":"...first fees In bullet….","sources":[]},{"bullet":"","sources":[]},{"bullet":"","sources":[]}],"out":[{"bullet":"….First fees out bullet….","sources":[]},{"bullet":"","sources":[]},{"bullet":"","sources":[]}]}]},{"id":"power","title":[{"type":"text","value":"The EU and Power"}],"intro":[{"type":"text","value":"We join other European countries in *signing up to the rules* of being in the EU, affecting things like fishing waters, renewable energy policies, limits on workers’ hours per week."},{"type":"sources","value":[]}],"in":[{"bullet":"💪 👥 **Stronger in:** In a competitive, 🌍 *globalised world*  the UK needs to stay in the EU to *help shape laws* which affect the UK from the inside.","sources":[]},{"bullet":"✌ 👊 **Double hit:** The government doesn’t just influence through voting but also in *negotiating over the actual text* of laws.","sources":[]},{"bullet":"💝 👍 **Helpful laws:** Many EU laws benefit the UK, for instance the new EU CAP will invest £22 billion over the next 7 years","sources":[]}],"out":[{"bullet":"💪 💬 **Big influence:** Between *15% and 55%* of UK laws and regulations stem from the EU.","sources":[{"type":"https","value":"//fullfact.org/news/what-proportion-uk-law-comes-brussels/"}]},{"bullet":"🙋 🚶 **Voted out:** In recent years the UK has been *on the losing side* of fighting EU laws, and now *loses a higher proportion of votes* than any other member.","sources":[]},{"bullet":"⛔ 🚷 **Held back:** Open Europe estimates that the 100 most expensive EU regulations set back the UK economy by £27.4 billion a year.","sources":[]}],"subsections":[]},{"id":"borders","title":[{"type":"text","value":"The EU and Borders"}],"intro":[{"type":"text","value":"Total net migration to the UK is over *300,000 a year*, half of which is from the EU, while the government’s target is under 100,000. EU citizens have the *right to live and work* in any member state."},{"type":"sources","value":[]}],"in":[{"bullet":"✈ ✅ **Migrants benefit us:** EU citizens living in Britain *pay more in taxes than they receive in benefits* and the Remain side say they’re good for the economy.","sources":[]},{"bullet":"🔧 🔩 **Tightening rules:** Benefits for new EU migrant workers will soon be *limited for the first four years*.","sources":[]}],"out":[{"bullet":"🔓 ⚠ **Lacking control:** Immigration can *only be controlled so much* when you’re an EU member","sources":[]},{"bullet":"🚷 🚪 **Security risks:** The Schengen Area means someone crossing the channel could have entered Europe *from almost any bordering country*.","sources":[]}],"subsections":[]}]';

$.doctop({
  url: 'https://docs.google.com/document/d/15oMHuBNX4CTMvaAm7piTaWVwpc8kaO0bDLg190p5Qdc/pub',
  archieml: true,
  cache: false,
  callback: function(d){
      notLoaded = false;
      console.dir(d);
      myData = d.copy.archie.sections;
      console.log(myData);
      getAllPanelsHTML(myData);
  }
});

var getAllPanelsHTML = function(data) {
  // $('.tab-content').html('');
  $.each(data, function(i, e) {
    var panelHTML = getPanelHTML(i, e);
    // $('.tab-content').append(panelHTML);
  });
};

var getPanelHTML = function(i, data) {
  var intro = boldify(data.intro[0].value);
  var inOut = getInOutHTML(data);
  var subsectionsHTML = '';
  var subsectionsHTML1 = '';
  $.each(data.subsections, function(i, e) {
    subsectionsHTML += getSubsectionHTML(e, '');
    subsectionsHTML1 += getSubsectionHTML(e, '1');
  });
  subsectionsHTML = '<div class="panel-group" id="accordion" role="tablist" aria-multiselectable="true">' + subsectionsHTML + '</div>';
  subsectionsHTML1 = '<div class="panel-group" id="accordion" role="tablist" aria-multiselectable="true">' + subsectionsHTML1 + '</div>';
  // var firstBit = i==0 ? ' in active' : '';
  // var panelHTML = '<div role="tabpanel" class="tab-pane fade' + firstBit + '" id="' + data.id + '1"><p>' + intro + inOut + '</p></div>';
  var panelHTML = '<p>' + intro + '</p>' + inOut + subsectionsHTML;
  var panelHTML1 = '<p>' + intro + '</p>' + inOut + subsectionsHTML1;
  $('#' + data.id + '1').html(panelHTML1);
  $('#' + data.id).html(panelHTML);
  // $('.panel-title a').click(function() {
    // console.log(this.getAttribute('href'));
    // $(this.getAttribute('href')).
  // })
  return panelHTML;
};

var getInOutHTML = function(data) {
  var allInOutHTML = '';
  var inHTML = '';
  var outHTML = '';
  $.each(data.in, function(i, e) {
    inHTML += '<li>' + boldify(e.bullet) + '</li>';
  });
  $.each(data.out, function(i, e) {
    outHTML += '<li>' + boldify(e.bullet) + '</li>';
  });
  inHTML = '<div class="in"><h3>In</h3><ul>' + inHTML + '</ul></div>';
  outHTML = '<div class="out"><h3>Out</h3><ul>' + outHTML + '</ul></div>';
  inOutHTML = '<div class="in-out">' + inHTML + outHTML + '</div>';
  return inOutHTML;
};

var getSubsectionHTML = function(data, desktop) {
  console.log(desktop);
  var intro = boldify(data.intro[0].value);
  var inOut = getSubsectionInOutHTML(data, desktop);
  var comingsoon = '<div class="coming-soon"><h3>⌛ This section is coming&nbsp;soon..! ⌛</h3><h4>🙈 🙉 🙊 Don\'t miss out on getting involved - <b>help us 📝 write this section</b>! 📨 Email <a href="mailto:FOMO@referendum.wtf">FOMO@referendum.wtf</a></h4></div>'
  var content = data.comingsoon ? comingsoon : intro + inOut;
  // var firstBit = i==0 ? ' in active' : '';
  var panelHTML = '<div class="panel panel-default"><div class="panel-heading" role="tab" id="heading' + data.id + desktop + '"><h4 class="panel-title"><a role="button" data-toggle="collapse" data-parent="#accordion" href="#collapse' + data.id + desktop + '"prices" aria-expanded="false" aria-controls="collapse' + data.id + desktop + '" class="collapsed">' + data.title[0].value + '</a></h4></div> <div id="collapse' + data.id + desktop + '" class="panel-collapse collapse" role="tabpanel" aria-labelledby="heading' + data.id + desktop + '"><div class="panel-body">' + content + '</div></div></div>';
  // var panelHTML = '<p>' + intro + inOut + '</p>';
  // $('#subsection-' + data.id + '1').html(panelHTML);
  // $('#subsection-' + data.id).html(panelHTML);
  return panelHTML;
}

var getSubsectionInOutHTML = function(data) {
  var allInOutHTML = '';
  var inHTML = '';
  var outHTML = '';
  $.each(data.in, function(i, e) {
    inHTML += '<li>' + boldify(e.bullet) + '</li>';
  });
  $.each(data.out, function(i, e) {
    outHTML += '<li>' + boldify(e.bullet) + '</li>';
  });
  inHTML = '<div class="in"><h3>In</h3><ul>' + inHTML + '</ul></div>';
  outHTML = '<div class="out"><h3>Out</h3><ul>' + outHTML + '</ul></div>';
  inOutHTML = '<div class="in-out">' + inHTML + outHTML + '</div>';
  return inOutHTML;
};

var boldify = function(text) {
  // bolded=text.replace(/\*.+\*/gi, function myFunction(x){return '<b>' + x + '</b>';});
  // bolded = bolded.replace(/\*/gi, "");
  var bolded = !text ? text : text.replace(/\*\*([^*]+?)\*\*/g, '<div class="bullet-heading">$1<\/div>')
                                  .replace(/\*([^*]+?)\*/g, '<b>$1<\/b>');
  return bolded;
}


setTimeout(function() {
  // if (notLoaded) {
    myData = $.parseJSON(backupMyData);
    getAllPanelsHTML(myData);
    // var whoops = '<div class="coming-soon"><h3>😳 Well, this is awkward..! 😳</h3><h4>🙈 🙉 🙊 We seem to have failed to load much here - <b>please help us figure out why</b>! 📨 Email <a href="mailto:whoops@referendum.wtf">whoops@referendum.wtf</a></h4></div>'
    // $('.tab-pane').html(whoops);
    // $('.tab-content').html(whoops);
  // }
}, 1000)
